<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../critter-level-mixin/critter-level-mixin.html">
<link rel="import" href="../critter-gameboard/critter-board.html">
<link rel="import" href="../critter-critter/critter-critter.html">
<link rel="import" href="../critter-button/critter-button.html">
<link rel="import" href="../critter-blockly/critter-blockly.html">
<link rel="import" href="../critter-tab/critter-tab.html">
<link rel="import" href="../critter-element-selector/critter-element-selector.html">
<link rel="import" href="../critter-mutant-creator/critter-mutant-creator.html">
<link rel="import" href="../critter-input/critter-input.html">
<link rel="import" href="../critter-toaster/critter-toaster.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">


<!--
# critter game

Displays the game elements

## Example
```html
<critter-level-creator width="NUMBER" height="NUMBER"></critter-level-creator>
```

@demo
-->

<dom-module id="critter-level-creator">
    <template>
        <custom-style>
            <style>
                :host {
                    display: block;
                }

                :host > * {
                    --overlay-margin-top: 40px;
                }

                .tab {
                    display: none;
                }

                .tab-0{
                    display: block;
                }

                .tab-1 critter-blockly {
                    width: 45%;
                    float: left;
                }

                #blockly_init{
                    margin-right: 5%;
                }

                #save_button {
                    margin-left: 20px;
                    float: left;
                }

                #gameboard,
                #element_selector{
                    float: left;
                }

                #element_selector{
                    margin-left: 20px;
                }

                #name_input{
                    clear: both;
                    float: left;
                    margin-left: 20px;
                }

                #coordinate_container{
                    min-height: 40px;
                    left: 70px;
                    position: relative;
                    align-items: center;
                    margin-left: 20px;
                    float: left;
                }

            </style>
        </custom-style>

        <critter-tab id="tabs" tabs="{{tabs}}"></critter-tab>
        <div class="tab-0 tab">
            <critter-gameboard id="gameboard" level="{{level}}" tower="{{tower}}" spawn="{{spawn}}" width="{{width}}"
                               height="{{height}}" selected-element="{{selectedElement}}" mines="{{mines}}"
                               towers="{{towers}}" modder="{{modder}}" show-grid="false" generator></critter-gameboard>
            <critter-element-selector id="element_selector"  selected-element="{{selectedElement}}" height$="{{ _boardHeight}}">
            </critter-element-selector>
        </div>
        <div  class="tab-1 tab">
            <critter-blockly id="blockly_init" height$="{{ _boardHeight}}" controls="true" trashcan="true" cut generator>
                <span>Init Code</span>
            </critter-blockly>
            <critter-blockly id="blockly_CUT" height$="{{ _boardHeight}}" controls="true" trashcan="true" cut generator>
                <span>CUT</span>
            </critter-blockly>
        </div>
        <div class="tab-2 tab">
            <critter-blockly id="blockly_test" height$="{{ _boardHeight}}" trashcan="true" controls="true" generator>
            </critter-blockly>
        </div>
        <div class="tab-3 tab">
            <critter-mutant-creator id="mutant_creator" height$="{{ _boardHeight}}" number-of-mutants="{{numberOfCritters}}"></critter-mutant-creator>
        </div>
        <br>
        <critter-input id="name_input" label="Name: " value="{{levelName}}"></critter-input>
        <critter-button id="save_button">Save</critter-button>
        <div id="coordinate_container">Coordinates: (X: {{_hoverX}}, Y: {{_hoverY}})</div>

    </template>
    <script>
        class CritterLevelCreator extends CritterMixins.Level(Polymer.Element) {
            static get is() {
                return 'critter-level-creator';
            }

            static get properties() {
                return {

                    numberOfCritters: {
                        type: Number,
                        value: 15
                    },

                    numberOfHumans: {
                        type: Number,
                        value: 5
                    },

                    selectedElement:{
                        type: String
                    },

                    tabs: {
                        type: Array,
                        value: [
                            {title: "Gameboard"},
                            {title: "CUT"},
                            {title: "Test"},
                            {title: "Critter"}
                        ]
                    },

                    _boardHeight: {
                        type: Number,
                        computed: '_computeBoardHeight(height, _blockSize)'
                    },

                    _blockSize: {
                        type: Number,
                        value: 40
                    },

                    _critterList: {
                        type: Array,
                        value: []
                    },

                    _hoverX: {
                        type: Number
                    },

                    _hoverY: {
                        type: Number
                    },

                    generator: {
                        type: Boolean,
                        value: true
                    },

                    _names: {
                        type: Array,
                        value: []
                    },

                    _toasterTime: {
                        type: Number,
                        value: 5000
                    }

                };
            }

            connectedCallback() {
                super.connectedCallback();

                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.$.save_button.addEventListener("click", this._saveLevel.bind(this));
                    this.$.gameboard.addEventListener("hoverOver", (event) => this._handleHoverField(event));
                    this.$.gameboard.addEventListener("fieldClicked", (event) => this._onFieldClicked(event));
                    this.$.name_input.addEventListener("valueChanged", (event) => this._validateLevelName(event));
                    this.$.tabs.addEventListener("tabChanged", (event)=> this._onTabChanged(event));
                    this._initLevel();
                    this._initNames();
                });
            }

            /** initializes an empty level **/
            _initLevel(){
                this.level = [];
                let array = [];
                for(let j = 0; j < this.width; ++j) {
                    array[j] = "grass";
                }
                for(let i = 0; i < this.width; ++i){
                    this.level[i] = array.slice();
                }
                this.$.gameboard.dispatchEvent(new CustomEvent('_levelChanged'));
            }

            /** gets all existing level names **/
            _initNames() {
                let req = document.createElement('iron-ajax');
                req.url = "/generator/names";
                req.method = "GET";
                req.handleAs = 'json';
                req.contentType = 'application/json';
                req.bubbles = true;
                req.rejectWithRequest = true;

                req.addEventListener('response', e => {
                    this._names = e.detail.__data.response;
                });

                let genRequest = req.generateRequest();
                req.completes = genRequest.completes;
                return req;
            }

            /** validates the Level Name **/
            _validateLevelName(event){
                this.$.name_input.valid = !this._names.includes(event.detail.name);
            }

            /** saves the Level Data**/
            _saveLevel() {
                if(this.levelName === '' ){
                    this.$.name_input.valid = false;
                }

                if(!this.$.name_input.valid){
                    let toaster = document.createElement("critter-toaster");
                    toaster.type = "error";
                    toaster.msg = "Please enter a valid name";
                    this.shadowRoot.append(toaster);
                    toaster.show(this._toasterTime);
                    return;
                }

                if(!this.$.blockly_CUT.getJavaScript()){
                    let toaster = document.createElement("critter-toaster");
                    toaster.type = "error";
                    toaster.msg = "Please create some CUT";
                    this.shadowRoot.append(toaster);
                    toaster.show(this._toasterTime);
                    return;
                }

                if(! this.tower || this.tower.x === -1){
                    let toaster = document.createElement("critter-toaster");
                    toaster.type = "error";
                    toaster.msg = "Please set the tower";
                    this.shadowRoot.append(toaster);
                    toaster.show(this._toasterTime);
                    return;
                }

                if(! this.spawn || this.spawn.x === -1){
                    let toaster = document.createElement("critter-toaster");
                    toaster.type = "error";
                    toaster.msg = "Please set the tower";
                    this.shadowRoot.append(toaster);
                    toaster.show(this._toasterTime);
                    return;
                }
                if(!this.existPath(this.spawn)){
                    let toaster = document.createElement("critter-toaster");
                    toaster.type = "error";
                    toaster.msg = "There is no path to the tower";
                    this.shadowRoot.append(toaster);
                    toaster.show(this._toasterTime);
                    return;
                }

                let req = document.createElement('iron-ajax');
                req.url = "/generator/level/create";
                req.method = "post";
                req.handleAs = 'json';
                req.contentType = 'application/json';
                req.bubbles = true;
                req.rejectWithRequest = true;
                req.body = {
                    name: this.levelName,
                    level: this.level,
                    tower: this.tower,
                    spawn: this.spawn,
                    numberOfCritters: this.numberOfCritters,
                    numberOfHumans: this.numberOfHumans,
                    cut: this.$.blockly_CUT.getXML(),
                    init: this.$.blockly_init.getXML(),
                    test: this.$.blockly_test.getXML()};

                req.addEventListener('response', e => {
                    let data = e.detail;
                    this.$.mutant_creator.saveMutants(this.levelName);
                });

                req.addEventListener('error', e => {
                    let toaster = document.createElement("critter-toaster");
                    toaster.type = "error";
                    toaster.msg = "Could not save level";
                    this.shadowRoot.append(toaster);
                    toaster.show(this._toasterTime);
                });

                let genRequest = req.generateRequest();
                req.completes = genRequest.completes;

                return req;
            }

            /** computes the heights of critter-board**/
            _computeBoardHeight(height, size) {
                return height * size;
            }

            /** handels the hover event and displays the coordinates **/
            _handleHoverField(event){
                let detail = event.detail;
                this._hoverX = detail.x + 1;
                this._hoverY = this.width - detail.y;
            }

            /** handels the clickField event and creates the element **/
            _onFieldClicked(event) {
                let detail = event.detail;
                let code = this.$.blockly_test.getJavaScript();
                if (code === '') {
                    //TODO warning
                    return;
                }
                detail.code =  new Function('x', 'y', code);
                detail.xml = this.$.blockly_test.getXML();
                this.mines.push(detail);
            }

            _onTabChanged(event) {
                let detail = event.detail;
                this.shadowRoot.querySelector('.tab-' + detail.old).style.display = "none";
                this.shadowRoot.querySelector('.tab-' + detail.new).style.display = "block";
                if(detail.old === 0){
                    this.shadowRoot.querySelector('#coordinate_container').style.display = "none";
                } else if (detail.new === 0){
                    this.shadowRoot.querySelector('#coordinate_container').style.display = "block";
                }
                if(detail.new === 3) {
                    this.$.mutant_creator.cut = this.$.blockly_CUT.getXML();
                    this.$.mutant_creator.init = this.$.blockly_init.getXML();
                }
            }

        }

        window.customElements.define(CritterLevelCreator.is, CritterLevelCreator)
    </script>
</dom-module>
